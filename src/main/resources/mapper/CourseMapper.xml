<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.smartcourse.mapper.CourseMapper">
    <select id="getCourseList" resultType="com.smartcourse.pojo.vo.course.TeacherCourseVO">
        SELECT c.id,
               c.name,
               COUNT(DISTINCT s.class_id) as count
        FROM evaluation_expert.course c
                 LEFT JOIN evaluation_expert.student_course sc ON c.id = sc.course_id
                 LEFT JOIN evaluation_expert.student s ON sc.student_id = s.id
        WHERE c.teacher_id = #{teacherId}
        GROUP BY c.id, c.name
    </select>

    <select id="getCourseExam" resultType="com.smartcourse.pojo.vo.course.StudentCourseVO">
        SELECT c.id,
               c.name,
               t.name                                                           AS teacherName,
               COUNT(DISTINCT e.id)                                             AS examNumber,
               SUM(CASE WHEN e.status = 'progressing' THEN 1 ELSE 0 END)        AS ongoing,
               SUM(CASE WHEN e.status = 'published' THEN 1 ELSE 0 END)          AS upcoming,
               SUM(CASE WHEN exam_score.status = 'submitted' THEN 1 ELSE 0 END) AS reviewing
        FROM evaluation_expert.student s
                 LEFT JOIN evaluation_expert.student_course sc ON s.id = sc.student_id
                 LEFT JOIN evaluation_expert.course c ON sc.course_id = c.id
                 LEFT JOIN evaluation_expert.teacher t ON c.teacher_id = t.id
                 LEFT JOIN evaluation_expert.exam e ON c.id = e.course_id
                 LEFT JOIN evaluation_expert.exam_score ON e.id = exam_score.exam_id AND exam_score.student_id = s.id
        WHERE s.id = #{studentId}
        GROUP BY c.id, c.name, t.name
    </select>

    <select id="getCourseTask" resultType="com.smartcourse.pojo.vo.course.StudentCourseTaskVO">
        SELECT c.id,
               c.name,
               t.name                                                  AS teacherName,
               COUNT(DISTINCT a.id) - COUNT(DISTINCT ss.assignment_id) AS pending,
               SUM(CASE WHEN ss.status = 'graded' THEN 1 ELSE 0 END)   AS submitted
        FROM evaluation_expert.student s
                 LEFT JOIN evaluation_expert.student_course sc ON s.id = sc.student_id
                 LEFT JOIN evaluation_expert.course c ON sc.course_id = c.id
                 LEFT JOIN evaluation_expert.teacher t ON c.teacher_id = t.id
                 LEFT JOIN evaluation_expert.assignment a ON c.id = a.course_id
                 LEFT JOIN evaluation_expert.assignment_score ss ON a.id = ss.assignment_id AND ss.student_id = s.id
        WHERE s.id = #{studentId}
        GROUP BY c.id, c.name, t.name
    </select>
</mapper>