<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.smartcourse.mapper.ExamMapper">

    <sql id="SectionIdSource">
        <trim suffixOverrides=" UNION ALL ">
            <foreach collection="sections" item="section">
                <if test="section != null and section.id != null">
                    SELECT #{section.id} AS id
                    FROM DUAL
                    UNION ALL
                </if>
            </foreach>
        </trim>
    </sql>

    <sql id="SectionIdInClause">
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <foreach collection="sections" item="section">
                <if test="section != null and section.id != null">
                    #{section.id},
                </if>
            </foreach>
        </trim>
    </sql>

    <sql id="ExamItemIdSource">
        <trim suffixOverrides=" UNION ALL ">
            <foreach collection="sections" item="section">
                <if test="section != null and section.examItems != null and section.examItems.size() > 0">
                    <foreach collection="section.examItems" item="item">
                        <if test="item != null and item.id != null">
                            SELECT #{item.id} AS id
                            FROM DUAL
                            UNION ALL
                        </if>
                    </foreach>
                </if>
            </foreach>
        </trim>
    </sql>

    <sql id="ExamItemIdInClause">
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <foreach collection="sections" item="section">
                <if test="section != null and section.examItems != null and section.examItems.size() > 0">
                    <foreach collection="section.examItems" item="item">
                        <if test="item != null and item.id != null">
                            #{item.id},
                        </if>
                    </foreach>
                </if>
            </foreach>
        </trim>
    </sql>

    <resultMap id="TeacherExamClassItemResultMap"
               type="com.smartcourse.pojo.vo.exam.items.TeacherExamClassItemVO">
        <id property="classId" column="class_id"/>
        <result property="className" column="class_name"/>
    </resultMap>

    <resultMap id="TeacherGetExamItemResultMap"
               type="com.smartcourse.pojo.vo.exam.items.TeacherGetExamItemVO">
        <id property="examId" column="exam_id"/>
        <result property="examName" column="exam_name"/>
        <result property="description" column="description"/>
        <result property="totalScore" column="total_score"/>
        <result property="startTime" column="start_time"/>
        <result property="durationMinutes" column="duration_minutes"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <collection property="classes"
                    column="exam_id"
                    ofType="com.smartcourse.pojo.vo.exam.items.TeacherExamClassItemVO"
                    select="getExamClassesByExamId"/>
    </resultMap>

    <select id="getTeacherGetExamItemVOListByCourseId"
            parameterType="long"
            resultMap="TeacherGetExamItemResultMap">
        SELECT e.id               AS exam_id,
               e.name             AS exam_name,
               e.description      AS description,
               e.total_score      AS total_score,
               e.start_time       AS start_time,
               e.duration_minutes AS duration_minutes,
               e.status           AS status,
               e.create_time      AS create_time,
               e.update_time      AS update_time
        FROM evaluation_expert.exam e
        WHERE e.course_id = #{courseId}
          AND e.deleted = 0
        ORDER BY e.create_time DESC
    </select>

    <!--首先动态拼接非null字段，更新exam表-->

    <update id="updateExamRecursive" parameterType="com.smartcourse.pojo.entity.Exam">
        UPDATE evaluation_expert.exam
        <trim prefix="SET" suffixOverrides=",">
            <if test="name != null">
                name = #{name},
            </if>
            <if test="description != null">
                description = #{description},
            </if>
            <if test="notice != null">
                notice = #{notice},
            </if>
            <if test="courseId != null">
                course_id = #{courseId},
            </if>
            <if test="totalScore != null">
                total_score = #{totalScore},
            </if>
            <if test="durationMinutes != null">
                duration_minutes = #{durationMinutes},
            </if>
            <if test="startTime != null">
                start_time = #{startTime},
            </if>
            <if test="passScore != null">
                pass_score = #{passScore},
            </if>
            <if test="shuffleQuestions != null">
                shuffle_questions = #{shuffleQuestions},
            </if>
            <if test="shuffleOptions != null">
                shuffle_options = #{shuffleOptions},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="version != null">
                version = #{version},
            </if>
            <if test="creator != null">
                creator = #{creator},
            </if>
            <if test="deleted != null">
                deleted = #{deleted},
            </if>
            update_time = NOW(),
        </trim>
        WHERE id = #{id}
        AND (
        SELECT CASE
        WHEN #{id} IS NULL THEN 1/0
        ELSE 1
        END
        ) = 1
        AND (
        SELECT CASE
        WHEN COUNT(1) = 1 THEN 1
        ELSE 1/0
        END
        FROM (
        SELECT e.id
        FROM evaluation_expert.exam e
        WHERE e.id = #{id}
        ) exam_exists
        ) = 1;

        <if test="hasExistingSections()">
            UPDATE evaluation_expert.exam_section
            <trim prefix="SET" suffixOverrides=",">
                title = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.id != null and section.title != null">
                        WHEN #{section.id} THEN #{section.title}
                    </if>
                </foreach>
                ELSE title
                END,
                question_type = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.id != null and section.questionType != null">
                        WHEN #{section.id} THEN #{section.questionType}
                    </if>
                </foreach>
                ELSE question_type
                END,
                description = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.id != null and section.description != null">
                        WHEN #{section.id} THEN #{section.description}
                    </if>
                </foreach>
                ELSE description
                END,
                choice_score = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.id != null and section.choiceScore != null">
                        WHEN #{section.id} THEN #{section.choiceScore}
                    </if>
                </foreach>
                ELSE choice_score
                END,
                order_no = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.id != null and section.orderNo != null">
                        WHEN #{section.id} THEN #{section.orderNo}
                    </if>
                </foreach>
                ELSE order_no
                END,
                note = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.id != null and section.note != null">
                        WHEN #{section.id} THEN #{section.note}
                    </if>
                </foreach>
                ELSE note
                END,
                choice_negative_score = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.id != null and section.choiceNegativeScore != null">
                        WHEN #{section.id} THEN #{section.choiceNegativeScore}
                    </if>
                </foreach>
                ELSE choice_negative_score
                END,
                multiple_strategy = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.id != null and section.multipleStrategy != null">
                        WHEN #{section.id} THEN #{section.multipleStrategy}
                    </if>
                </foreach>
                ELSE multiple_strategy
                END,
                multiple_strategy_conf = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.id != null and section.multipleStrategyConf != null">
                        WHEN #{section.id} THEN #{section.multipleStrategyConf}
                    </if>
                </foreach>
                ELSE multiple_strategy_conf
                END,
                update_time = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.id != null">
                        WHEN #{section.id} THEN NOW()
                    </if>
                </foreach>
                ELSE update_time
                END
            </trim>
            WHERE exam_id = #{id}
            AND id IN
            <include refid="SectionIdInClause"/>
            AND (
            SELECT CASE
            WHEN EXISTS (
            SELECT 1
            FROM (
            <include refid="SectionIdSource"/>
            ) section_ids
            LEFT JOIN (
            SELECT s.id, s.exam_id
            FROM evaluation_expert.exam_section s
            ) sec ON sec.id = section_ids.id
            WHERE sec.id IS NULL OR sec.exam_id &lt;&gt; #{id}
            ) THEN 1/0
            ELSE 1
            END
            ) = 1;
        </if>

        <if test="hasExistingExamItems()">
            UPDATE evaluation_expert.exam_item
            <trim prefix="SET" suffixOverrides=",">
                section_id = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.examItems != null and section.examItems.size() > 0">
                        <foreach collection="section.examItems" item="item">
                            <if test="item != null and item.id != null">
                                WHEN #{item.id}
                                THEN
                                <choose>
                                    <when test="item.sectionId != null">
                                        #{item.sectionId}
                                    </when>
                                    <otherwise>
                                        #{section.id}
                                    </otherwise>
                                </choose>
                            </if>
                        </foreach>
                    </if>
                </foreach>
                ELSE section_id
                END,
                question_id = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.examItems != null and section.examItems.size() > 0">
                        <foreach collection="section.examItems" item="item">
                            <if test="item != null and item.id != null and item.questionId != null">
                                WHEN #{item.id} THEN #{item.questionId}
                            </if>
                        </foreach>
                    </if>
                </foreach>
                ELSE question_id
                END,
                score = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.examItems != null and section.examItems.size() > 0">
                        <foreach collection="section.examItems" item="item">
                            <if test="item != null and item.id != null and item.score != null">
                                WHEN #{item.id} THEN #{item.score}
                            </if>
                        </foreach>
                    </if>
                </foreach>
                ELSE score
                END,
                order_no = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.examItems != null and section.examItems.size() > 0">
                        <foreach collection="section.examItems" item="item">
                            <if test="item != null and item.id != null and item.orderNo != null">
                                WHEN #{item.id} THEN #{item.orderNo}
                            </if>
                        </foreach>
                    </if>
                </foreach>
                ELSE order_no
                END,
                question_type = CASE id
                <foreach collection="sections" item="section">
                    <if test="section != null and section.examItems != null and section.examItems.size() > 0 and section.questionType != null">
                        <foreach collection="section.examItems" item="item">
                            <if test="item != null and item.id != null">
                                WHEN #{item.id} THEN #{section.questionType}
                            </if>
                        </foreach>
                    </if>
                </foreach>
                ELSE question_type
                END
            </trim>
            WHERE id IN
            <include refid="ExamItemIdInClause"/>
            AND (
            SELECT CASE
            WHEN EXISTS (
            SELECT 1
            FROM (
            <include refid="ExamItemIdSource"/>
            ) item_ids
            LEFT JOIN (
            SELECT ei.id, ei.section_id
            FROM evaluation_expert.exam_item ei
            ) ex_item ON ex_item.id = item_ids.id
            LEFT JOIN (
            SELECT s.id, s.exam_id
            FROM evaluation_expert.exam_section s
            ) section_ref ON section_ref.id = ex_item.section_id
            WHERE ex_item.id IS NULL OR section_ref.exam_id &lt;&gt; #{id}
            ) THEN 1/0
            ELSE 1
            END
            ) = 1;
        </if>
    </update>

    <update id="updateExamSelective" parameterType="com.smartcourse.pojo.entity.Exam">
        UPDATE evaluation_expert.exam
        <trim prefix="SET" suffixOverrides=",">
            <if test="name != null">
                name = #{name},
            </if>
            <if test="description != null">
                description = #{description},
            </if>
            <if test="notice != null">
                notice = #{notice},
            </if>
            <if test="courseId != null">
                course_id = #{courseId},
            </if>
            <if test="totalScore != null">
                total_score = #{totalScore},
            </if>
            <if test="durationMinutes != null">
                duration_minutes = #{durationMinutes},
            </if>
            <if test="startTime != null">
                start_time = #{startTime},
            </if>
            <if test="passScore != null">
                pass_score = #{passScore},
            </if>
            <if test="shuffleQuestions != null">
                shuffle_questions = #{shuffleQuestions},
            </if>
            <if test="shuffleOptions != null">
                shuffle_options = #{shuffleOptions},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="version != null">
                version = #{version},
            </if>
            <if test="creator != null">
                creator = #{creator},
            </if>
            <if test="deleted != null">
                deleted = #{deleted},
            </if>
            update_time = NOW(),
        </trim>
        WHERE id = #{id}
    </update>

    <select id="getList" resultType="com.smartcourse.pojo.vo.exam.ExamList">
        SELECT e.id                                          AS examId,
               e.name                                        AS examName,
               IF(s.exam_id IS NOT NULL, s.status, e.status) AS status,
               e.total_score,
               e.duration_minutes,
               e.pass_score,
               e.start_time
        FROM evaluation_expert.exam e
                 LEFT JOIN evaluation_expert.exam_score s ON e.id = s.exam_id
        WHERE e.course_id = #{courseId}
          AND (e.status = 'published' OR e.status = 'progressing')
    </select>

    <select id="getExamClassesByExamId"
            resultMap="TeacherExamClassItemResultMap"
            parameterType="long">
        SELECT ec.class_id AS class_id,
               c.name      AS class_name
        FROM evaluation_expert.exam_class ec
                 INNER JOIN evaluation_expert.`class` c ON ec.class_id = c.id
        WHERE ec.exam_id = #{examId}
    </select>

    <select id="getQuestion" resultType="com.smartcourse.pojo.vo.knowledge.NodeQuestionVO">
        select ei.question_id, ei.score as totalScore, esi.score, ei.question_type
        from evaluation_expert.exam_section es
                 left join evaluation_expert.exam_score s on s.exam_id = #{examId} and s.student_id = #{studentId}
                 left join evaluation_expert.exam_item ei on es.id = ei.section_id
                 left join evaluation_expert.exam_score_item esi on ei.id = esi.exam_item_id and esi.score_id = s.id
        where es.exam_id = #{examId}
    </select>

    <select id="getClassQuestion" resultType="com.smartcourse.pojo.vo.knowledge.NodeQuestionVO">
        SELECT
            s.student_id as studentId,
            ei.question_id as questionId,
            ei.score as totalScore,
            esi.score,
            ei.question_type as questionType
        FROM evaluation_expert.exam_section es
                 LEFT JOIN evaluation_expert.student ON student.class_id = #{classId}
                 LEFT JOIN evaluation_expert.exam_score s
                           ON s.exam_id = #{examId} AND student.id = s.student_id
                 LEFT JOIN evaluation_expert.exam_item ei ON es.id = ei.section_id
                 LEFT JOIN evaluation_expert.exam_score_item esi
                           ON ei.id = esi.exam_item_id AND esi.score_id = s.id
        WHERE es.exam_id = #{examId}
    </select>

</mapper>
