<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.smartcourse.mapper.ExamMapper">

    <sql id="SectionIdSource">
        <trim suffixOverrides=" UNION ALL ">
            <foreach collection="sections" item="section">
                <if test="section != null and section.id != null">
                    SELECT #{section.id} AS id
                    FROM DUAL
                    UNION ALL
                </if>
            </foreach>
        </trim>
    </sql>

    <sql id="SectionIdInClause">
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <foreach collection="sections" item="section">
                <if test="section != null and section.id != null">
                    #{section.id},
                </if>
            </foreach>
        </trim>
    </sql>

    <sql id="ExamItemIdSource">
        <trim suffixOverrides=" UNION ALL ">
            <foreach collection="sections" item="section">
                <if test="section != null and section.examItems != null and section.examItems.size() > 0">
                    <foreach collection="section.examItems" item="item">
                        <if test="item != null and item.id != null">
                            SELECT #{item.id} AS id
                            FROM DUAL
                            UNION ALL
                        </if>
                    </foreach>
                </if>
            </foreach>
        </trim>
    </sql>

    <sql id="ExamItemIdInClause">
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <foreach collection="sections" item="section">
                <if test="section != null and section.examItems != null and section.examItems.size() > 0">
                    <foreach collection="section.examItems" item="item">
                        <if test="item != null and item.id != null">
                            #{item.id},
                        </if>
                    </foreach>
                </if>
            </foreach>
        </trim>
    </sql>

    <resultMap id="TeacherExamClassItemResultMap"
               type="com.smartcourse.pojo.vo.exam.items.TeacherExamClassItemVO">
        <id property="classId" column="class_id"/>
        <result property="className" column="class_name"/>
    </resultMap>

    <resultMap id="TeacherGetExamItemResultMap"
               type="com.smartcourse.pojo.vo.exam.items.TeacherGetExamItemVO">
        <id property="examId" column="exam_id"/>
        <result property="examName" column="exam_name"/>
        <result property="description" column="description"/>
        <result property="totalScore" column="total_score"/>
        <result property="startTime" column="start_time"/>
        <result property="durationMinutes" column="duration_minutes"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <collection property="classes"
                    column="exam_id"
                    ofType="com.smartcourse.pojo.vo.exam.items.TeacherExamClassItemVO"
                    select="getExamClassesByExamId"/>
    </resultMap>

    <select id="getTeacherGetExamItemVOListByCourseId"
            parameterType="long"
            resultMap="TeacherGetExamItemResultMap">
        SELECT e.id               AS exam_id,
               e.name             AS exam_name,
               e.description      AS description,
               e.total_score      AS total_score,
               e.start_time       AS start_time,
               e.duration_minutes AS duration_minutes,
               e.status           AS status,
               e.create_time      AS create_time,
               e.update_time      AS update_time
        FROM evaluation_expert.exam e
        WHERE e.course_id = #{courseId}
          AND e.deleted = 0
        ORDER BY e.create_time DESC
    </select>

    <!--首先动态拼接非null字段，更新exam表-->

    <update id="updateExamRecursive" parameterType="com.smartcourse.pojo.entity.Exam">
        UPDATE evaluation_expert.exam
        <trim prefix="SET" suffixOverrides=",">
            <if test="name != null">
                name = #{name},
            </if>
            <if test="description != null">
                description = #{description},
            </if>
            <if test="notice != null">
                notice = #{notice},
            </if>
            <if test="courseId != null">
                course_id = #{courseId},
            </if>
            <if test="totalScore != null">
                total_score = #{totalScore},
            </if>
            <if test="durationMinutes != null">
                duration_minutes = #{durationMinutes},
            </if>
            <if test="startTime != null">
                start_time = #{startTime},
            </if>
            <if test="passScore != null">
                pass_score = #{passScore},
            </if>
            <if test="shuffleQuestions != null">
                shuffle_questions = #{shuffleQuestions},
            </if>
            <if test="shuffleOptions != null">
                shuffle_options = #{shuffleOptions},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="version != null">
                version = #{version},
            </if>
            <if test="creator != null">
                creator = #{creator},
            </if>
            <if test="deleted != null">
                deleted = #{deleted},
            </if>
            update_time = NOW(),
        </trim>
        WHERE id = #{id}
        AND (
        SELECT CASE
        WHEN #{id} IS NULL THEN 1/0
        ELSE 1
        END
        ) = 1
        AND (
        SELECT CASE
        WHEN COUNT(1) = 1 THEN 1
        ELSE 1/0
        END
        FROM (
        SELECT e.id
        FROM evaluation_expert.exam e
        WHERE e.id = #{id}
        ) exam_exists
        ) = 1;

    </update>

    <update id="updateExamSelective" parameterType="com.smartcourse.pojo.entity.Exam">
        UPDATE evaluation_expert.exam
        <trim prefix="SET" suffixOverrides=",">
            <if test="name != null">
                name = #{name},
            </if>
            <if test="description != null">
                description = #{description},
            </if>
            <if test="notice != null">
                notice = #{notice},
            </if>
            <if test="courseId != null">
                course_id = #{courseId},
            </if>
            <if test="totalScore != null">
                total_score = #{totalScore},
            </if>
            <if test="durationMinutes != null">
                duration_minutes = #{durationMinutes},
            </if>
            <if test="startTime != null">
                start_time = #{startTime},
            </if>
            <if test="passScore != null">
                pass_score = #{passScore},
            </if>
            <if test="shuffleQuestions != null">
                shuffle_questions = #{shuffleQuestions},
            </if>
            <if test="shuffleOptions != null">
                shuffle_options = #{shuffleOptions},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="version != null">
                version = #{version},
            </if>
            <if test="creator != null">
                creator = #{creator},
            </if>
            <if test="deleted != null">
                deleted = #{deleted},
            </if>
            update_time = NOW(),
        </trim>
        WHERE id = #{id}
    </update>

    <select id="getList" resultType="com.smartcourse.pojo.vo.exam.ExamList">
        SELECT e.id                                          AS examId,
               e.name                                        AS examName,
               IF(s.exam_id IS NOT NULL, s.status, e.status) AS status,
               e.total_score,
               e.duration_minutes,
               e.pass_score,
               e.start_time
        FROM evaluation_expert.exam e
                 LEFT JOIN evaluation_expert.exam_score s ON e.id = s.exam_id
        WHERE e.course_id = #{courseId}
          AND (e.status != 'draft')
    </select>

    <select id="getExamClassesByExamId"
            resultMap="TeacherExamClassItemResultMap"
            parameterType="long">
        SELECT ec.class_id AS class_id,
               c.name      AS class_name
        FROM evaluation_expert.exam_class ec
                 INNER JOIN evaluation_expert.`class` c ON ec.class_id = c.id
        WHERE ec.exam_id = #{examId}
    </select>

    <select id="getQuestion" resultType="com.smartcourse.pojo.vo.knowledge.NodeQuestionVO">
        select ei.question_id, ei.score as totalScore, esi.score, ei.question_type
        from evaluation_expert.exam_section es
                 left join evaluation_expert.exam_score s on s.exam_id = #{examId} and s.student_id = #{studentId}
                 left join evaluation_expert.exam_item ei on es.id = ei.section_id
                 left join evaluation_expert.exam_score_item esi on ei.id = esi.exam_item_id and esi.score_id = s.id
        where es.exam_id = #{examId}
    </select>

    <select id="selectByStatus" parameterType="string" resultType="com.smartcourse.pojo.entity.Exam">
        SELECT *
        FROM evaluation_expert.exam
        WHERE status = #{status}
          AND deleted = 0
    </select>

    <select id="getClassQuestion" resultType="com.smartcourse.pojo.vo.knowledge.NodeQuestionVO">
        SELECT
            s.student_id as studentId,
            ei.question_id as questionId,
            ei.score as totalScore,
            esi.score,
            ei.question_type as questionType
        FROM evaluation_expert.exam_section es
                 LEFT JOIN evaluation_expert.student ON student.class_id = #{classId}
                 LEFT JOIN evaluation_expert.exam_score s
                           ON s.exam_id = #{examId} AND student.id = s.student_id
                 LEFT JOIN evaluation_expert.exam_item ei ON es.id = ei.section_id
                 LEFT JOIN evaluation_expert.exam_score_item esi
                           ON ei.id = esi.exam_item_id AND esi.score_id = s.id
        WHERE es.exam_id = #{examId}
    </select>

</mapper>
